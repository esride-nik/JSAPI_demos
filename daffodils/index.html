<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Import glTF 3D Models - 4.14</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.14/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.14/"></script>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #paneDiv {
      padding: 10px;
      max-width: 200px;
      background-color: rgba(255, 255, 255, 0.8);
      font-size: 1.1em;
    }

    #credits {
      font-size: 0.7em;
      line-height: 1.1em;
    }
  </style>
  <script>
    require([
      "esri/views/SceneView",
      "esri/WebScene",
      "esri/Map",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/layers/FeatureLayer",
      "esri/geometry/Point",
      "esri/geometry/support/webMercatorUtils",
      "esri/widgets/Sketch/SketchViewModel",
      "esri/geometry/Mesh",
      "esri/geometry/geometryEngine"
    ], function (SceneView, WebScene, Map, Graphic, GraphicsLayer, FeatureLayer, Point, webMercatorUtils, SketchViewModel, Mesh, geometryEngine) {

      function getRndPercent(min = 0, max = 100) {
        let rnd = Math.random() * (max - min + 1) + min;
        let pc = rnd / 100.0;
        return pc;
      }

      let coordinates = webMercatorUtils.geographicToWebMercator(
        new Point({ y: 41.391256, x: -70.632368 })
      );

      // load web scene from ArcGIS Online
      const webScene = new WebScene({
        portalItem: {
          // autocasts as new PortalItem()
          id: "727b8d56811048c4a3c636c762b2a159"
        }
      });

      const view = new SceneView({
        container: "viewDiv",
        map: webScene
      });

      const modelLayer = new GraphicsLayer({
        id: "modelLayer"
      });
      view.map.add(modelLayer);

      let daffodilPatterns = new FeatureLayer({
        url: "https://services.arcgis.com/OLiydejKCZTGhvWg/arcgis/rest/services/Daffodil_Patterns/FeatureServer/3",
        id: "daffodilPatterns"
      })
      // view.map.add(daffodilPatterns);


      const maxDist = 2;
      const maxHeight = 1;

      // Queries for all the features in the service (not the graphics in the view)
      daffodilPatterns.queryFeatures().then(function (results) {
        // prints an array of all the features in the service to the console
        console.log("daffodilPatterns query", results.features);

        let allGeo = results.features.map((result) => result.geometry);
        let unGeo = geometryEngine.union(allGeo);

        console.log("result geo", allGeo, unGeo);

        let ext = unGeo.extent;
        let xDist = maxDist * getRndPercent();
        let yDist = maxDist * getRndPercent();
        let pointCounter = 0;
        let rowCounter = 0;
        for (let x = ext.xmin; x < ext.xmax; x += xDist) {
          for (let y = ext.ymin; y < ext.ymax; y += yDist) {
            let point = new Point({
              y: y,
              x: x,
              spatialReference: unGeo.spatialReference
            });
            if (geometryEngine.contains(unGeo, point)) {
              let heading = Math.random() * 360;
              let height = maxHeight * getRndPercent(50,100);
              let graphic = new Graphic({
                geometry: point,
                symbol: {
                  type: "point-3d",
                  symbolLayers: [
                    {
                      type: "object",
                      resource: {
                        href:
                          "./Daffodil_426_te1.glb"
                      },
                      height: height,
                      heading: heading,
                    }
                  ]
                }
              });
              modelLayer.add(graphic);
              console.log("graphic ", graphic, height, heading);
              pointCounter++;
            }
            yDist = maxDist * getRndPercent();
          }
          xDist = maxDist * getRndPercent();
          rowCounter++;
          console.log("row ", rowCounter, " pointCounter", pointCounter);
        }
        console.log("total pointCounter", pointCounter);
      });




      const tentBtn = document.getElementById("tent");
      const canoeBtn = document.getElementById("canoe");

      view
        .when(function () {

          // view.goTo({"position":{"spatialReference":{"latestWkid":3857,"wkid":102100},"x":-7882674.341412749,"y":5061855.148433044,"z":380.1221046987921},"heading":11.811022479572395,"tilt":66.98044169291248}, { duration: 1000 });
          // // view.goTo(coordinates, { duration: 1000 });

          // view.watch("camera", (c) => {
          //   console.log(JSON.stringify(c));
          // })

          // This sample uses the SketchViewModel to add points to a
          // GraphicsLayer. The points have 3D glTF models as symbols.
          const sketchVM = new SketchViewModel({
            layer: modelLayer,
            view: view
          });

          tentBtn.addEventListener("click", function () {
            // reference the relative path to the glTF model
            // in the resource of an ObjectSymbol3DLayer
            sketchVM.pointSymbol = {
              type: "point-3d",
              symbolLayers: [
                {
                  type: "object",
                  resource: {
                    href:
                      "./Daffodil_426ed1.gltf"
                  },
                  height: 10
                }
              ]
            };
            sketchVM.create("point");
            deactivateButtons();
            this.classList.add("esri-button--secondary");
          });

          canoeBtn.addEventListener("click", function () {
            // reference the relative path to the glTF model
            // in the resource of an ObjectSymbol3DLayer
            sketchVM.pointSymbol = {
              type: "point-3d",
              symbolLayers: [
                {
                  type: "object",
                  resource: {
                    href:
                      "./bs_Daffodil.glb"
                  },
                  height: 10
                }
              ]
            };
            // deactivateButtons();
            sketchVM.create("point");
            // this.classList.add("esri-button--secondary");
          });

          sketchVM.on("create", function (event) {
            if (event.state === "complete") {
              sketchVM.update(event.graphic);
              deactivateButtons();
            }
          });
        })
        .catch(console.error);

      function deactivateButtons() {
        const elements = Array.prototype.slice.call(
          document.getElementsByClassName("esri-button")
        );
        elements.forEach(function (element) {
          element.classList.remove("esri-button--secondary");
        });
      }

      view.ui.add("paneDiv", "top-right");
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="paneDiv" class="esri-widget">
    <p>Select a symbol and place it in the scene:</p>
    <button id="tent" class="esri-button">Tent</button><br />
    <button id="canoe" class="esri-button">Canoe</button>
    <p id="credits">
      Tent and canoe glTF models from
      <a href="https://www.kenney.nl/assets/" target="_blank">Kenney game assets</a>
      under
      <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CC0 1.0 Universal</a>.
    </p>
  </div>
</body>

</html>